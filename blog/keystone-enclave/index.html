<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Keystone Enclave | Luca Giorgino</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://lucagiorgino.github.io/img/luca-social-card.png.png"><meta data-rh="true" name="twitter:image" content="https://lucagiorgino.github.io/img/luca-social-card.png.png"><meta data-rh="true" property="og:url" content="https://lucagiorgino.github.io/blog/keystone-enclave"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Keystone Enclave | Luca Giorgino"><meta data-rh="true" name="description" content="This post outlines the functionalities of the Keystone Enclave framework, extracted from my master&#x27;s thesis (updated to December 2022). Keystone is an open-source framework designed for building Trusted Execution Environments, adaptable for various platforms that are based on RISC-V hardware."><meta data-rh="true" property="og:description" content="This post outlines the functionalities of the Keystone Enclave framework, extracted from my master&#x27;s thesis (updated to December 2022). Keystone is an open-source framework designed for building Trusted Execution Environments, adaptable for various platforms that are based on RISC-V hardware."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2024-02-15T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/lucagiorgino"><meta data-rh="true" property="article:tag" content="trusted-computing"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://lucagiorgino.github.io/blog/keystone-enclave"><link data-rh="true" rel="alternate" href="https://lucagiorgino.github.io/blog/keystone-enclave" hreflang="en"><link data-rh="true" rel="alternate" href="https://lucagiorgino.github.io/blog/keystone-enclave" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","@id":"https://lucagiorgino.github.io/blog/keystone-enclave","mainEntityOfPage":"https://lucagiorgino.github.io/blog/keystone-enclave","url":"https://lucagiorgino.github.io/blog/keystone-enclave","headline":"Keystone Enclave","name":"Keystone Enclave","description":"This post outlines the functionalities of the Keystone Enclave framework, extracted from my master's thesis (updated to December 2022). Keystone is an open-source framework designed for building Trusted Execution Environments, adaptable for various platforms that are based on RISC-V hardware.","datePublished":"2024-02-15T00:00:00.000Z","author":{"@type":"Person","name":"Luca Giorgino","description":"Me","url":"https://github.com/lucagiorgino","image":"https://github.com/lucagiorgino.png"},"keywords":[],"isPartOf":{"@type":"Blog","@id":"https://lucagiorgino.github.io/blog","name":"Blog"}}</script><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="Luca Giorgino RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="Luca Giorgino Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6XTZ9YMEBB"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-6XTZ9YMEBB",{anonymize_ip:!0})</script>




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.ffbec4e5.css">
<script src="/assets/js/runtime~main.a79fae1a.js" defer="defer"></script>
<script src="/assets/js/main.f2be79ca.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Luca Giorgino</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lucagiorgino/lucagiorgino.github.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><div role="group"><h3 class="yearGroupHeading_rMGB">2024</h3><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a aria-current="page" class="sidebarItemLink_mo7H sidebarItemLinkActive_I1ZP" href="/blog/keystone-enclave">Keystone Enclave</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/what-i-learnt-using-actix-web">What I learnt using Actix-web</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/how-i-structure-my-react-applications">How I structure my React applications</a></li></ul></div></nav></aside><main class="col col--7"><article class=""><header><h1 class="title_f1Hy">Keystone Enclave</h1><div class="container_mt6G margin-vert--md"><time datetime="2024-02-15T00:00:00.000Z">February 15, 2024</time> · <!-- -->15 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--12 authorCol_Hf19"><div class="avatar margin-bottom--sm"><a href="https://github.com/lucagiorgino" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo authorImage_XqGP" src="https://github.com/lucagiorgino.png" alt="Luca Giorgino"></a><div class="avatar__intro authorDetails_lV9A"><div class="avatar__name"><a href="https://github.com/lucagiorgino" target="_blank" rel="noopener noreferrer"><span class="authorName_yefp">Luca Giorgino</span></a></div><small class="authorTitle_nd0D" title="Me">Me</small><div class="authorSocials_rSDt"></div></div></div></div></div></header><div id="__blog-post-container" class="markdown"><p>This post outlines the functionalities of the <a href="https://keystone-enclave.org/" target="_blank" rel="noopener noreferrer">Keystone Enclave</a> framework, extracted from my master&#x27;s thesis <em>(updated to December 2022)</em>. Keystone is an open-source framework designed for building Trusted Execution Environments, adaptable for various platforms that are based on RISC-V hardware.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-execution-environment">Trusted Execution Environment<a href="#trusted-execution-environment" class="hash-link" aria-label="Direct link to Trusted Execution Environment" title="Direct link to Trusted Execution Environment">​</a></h2>
<p>A <strong>Trusted Execution Environment (TEE)</strong> is an execution environment that runs alongside but is isolated from the device&#x27;s main operating system.
It ensures that the <em>confidentiality</em> and <em>integrity</em> of the code and data loaded in the TEE are preserved.
Trusted applications running on TEE have access to the full capabilities of a device&#x27;s main processor and memory, while hardware isolation shields these components from user-installed apps running in the main operating system. The various included trusted applications are protected from one another by software and cryptographic isolations within the TEE.<br>
<!-- -->The two most common TEE implementations at the moment are ARM TrustZone and Intel SGX. All these TEEs make design decisions based on either the target applications or threat models and these choices are fixed since they are strictly hardware related. They were not designed to have flexibility or extensibility for enclave developers. If the hardware changes or has a new feature, the enclave developer has to redesign the TEE.
All TEE platforms aim to reduce the enclave&#x27;s trusted computing base, and they have managed to achieve different degrees of success. The <a href="https://apps.dtic.mil/sti/pdfs/ADA108831.pdf" target="_blank" rel="noopener noreferrer">Trusted Computing Base (TCB)</a> is a section of the system, which could include hardware, firmware and software. It is responsible for enforcing the security policy of the system. Additionally, closed-source hardware and microcode implementations make it impossible for a third party to evaluate the security of TEEs.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="customizable-trusted-execution-environment">Customizable Trusted Execution Environment<a href="#customizable-trusted-execution-environment" class="hash-link" aria-label="Direct link to Customizable Trusted Execution Environment" title="Direct link to Customizable Trusted Execution Environment">​</a></h3>
<p><a href="https://keystone-enclave.org/2019/07/22/Keystone-Paper.html" target="_blank" rel="noopener noreferrer">Customizable TEE</a> is the solution to closed-source hardware-implemented TEEs problems. It has been designed to be flexible, and configurable and to have a small TCB. It has been designed with clear abstractions and a modular programming model which simplifies for others to extend and add features to the TEE. An example of a customizable TEE is Keystone. Three logical actors, such as the manufacturer (who makes the hardware), the platform provider (runs the hardware, such as a cloud provider), and the enclave developer (who writes software that runs in the enclaves), were identified by Keystone developers as being a part of the customizable TEE ecosystem. In a customizable TEE, as opposed to a standard TEE, decisions made by all 3 actors together determine the security guarantees offered and the functionalities enabled.<br>
<!-- -->Keystone offers security primitives that can be joined together via the software framework rather than creating a single instance of TEE hardware. The TEE can be modified by the creator of the enclave and the platform provider to suit their threat models or platform configurations. The Keystone project offers a general and formally proven interface for a variety of devices to create an open standard for TEEs.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="risc-v-background">RISC-V Background<a href="#risc-v-background" class="hash-link" aria-label="Direct link to RISC-V Background" title="Direct link to RISC-V Background">​</a></h2>
<p><a href="https://riscv.org/technical/specifications/" target="_blank" rel="noopener noreferrer">RISC-V</a> is open-source, which provides Keystone with several benefits. The most noticeable is that anyone can see how it works, understand the threat model it can operate under, and verify how exploits/patches function.<br>
<!-- -->Other advantages of RISC-V are security-oriented primitives, which provide efficient isolation, the most notable being <a href="https://sifive.github.io/freedom-metal-docs/devguide/pmps.html" target="_blank" rel="noopener noreferrer">Physical Memory Protection (PMP)</a>. RISC-V is an evolving and community-driven Instruction Set Architecture (ISA). Keystone has been designed and developed using RISC-V standard security features. Moreover, the ever-growing world of RISC-V gives Keystone a wide variety of potential platforms and different deployment scenarios to which it can adapt to.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="risc-v-privilieged-isa">RISC-V Privilieged ISA<a href="#risc-v-privilieged-isa" class="hash-link" aria-label="Direct link to RISC-V Privilieged ISA" title="Direct link to RISC-V Privilieged ISA">​</a></h3>
<p><a href="https://riscv.org/technical/specifications/" target="_blank" rel="noopener noreferrer">RISC-V</a> has three software privilege levels (in increasing order of capability): user mode (U-mode), supervisor mode (S-mode), and machine mode (M-mode). Only one of the privilege modes can be active on the processor at once.<br>
<!-- -->The active privilege level determines what the software can do while it is running. These are typical applications for each level of privilege:</p>
<ul>
<li><em>U-mode</em>: user processes</li>
<li><em>S-mode</em>: kernel (including kernel modules and device drivers) or hypervisor</li>
<li><em>M-mode</em>: bootloader and firmware.</li>
</ul>
<p>When the processor is in the highest privilege mode, M-mode, it is in control of all physical resources and interrupts. As with microcode in Complex Instruction Set Computer (CISC) ISAs (such as x86), M-mode is not interruptible and not affected by the interference of lower modes. M-mode is used in Keystone for executing the TCB of the system, the <em>security monitor</em> (SM).</p>
<p><img decoding="async" loading="lazy" alt="keystone-vs-x86" src="/assets/images/TEE-keystone-vs-x86-f29d0c9688224df0408d314dd155a152.svg" width="701" height="621" class="img_ev3q"> <em>Architecture differences between x86 and Keystone</em></p>
<p>The following are some advantages of utilizing an M-mode software as the TCB:</p>
<ul>
<li>programmability: unlike microcode for x86, in RISC-V M-mode software can be written using pre-existing toolchains and programming languages, such as C</li>
<li>agile patching: since the TCB is purely software, bugs or vulnerabilities can be patched without updates, which are specific to a particular hardware</li>
<li>verifiability: compared to hardware, the software is generally simpler to be formally verified.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="physical-memory-protection">Physical Memory Protection<a href="#physical-memory-protection" class="hash-link" aria-label="Direct link to Physical Memory Protection" title="Direct link to Physical Memory Protection">​</a></h3>
<p><a href="https://sifive.github.io/freedom-metal-docs/devguide/pmps.html" target="_blank" rel="noopener noreferrer">Physical Memory Protection (PMP)</a> is a strong standard primitive that enables M-mode to control the access to physical memory from lower privileges modes. Keystone requires PMP to implement memory isolation of enclaves.
Only software in M-mode can configure the PMP, which is controlled by a series of control and status registers (CSR) that limit physical memory access to the U-mode and S-mode. Depending on the platform design, PMP entries number can change.</p>
<p><img decoding="async" loading="lazy" alt="pmp-img" src="/assets/images/pmp-reg-79032473a5757e2b1fb12a20b4ea0e02.svg" width="521" height="401" class="img_ev3q"> <em>Image representing PMP registers</em></p>
<p>Since PMP exclusively works on physical addresses, S-mode can continue to support virtual addresses without affecting the security of the system. Even though each processor may implement PMP differently in hardware, the basic guarantees are part of the standard. PMP is used by Keystone Security Monitor to create memory isolation.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keystone-components">Keystone components<a href="#keystone-components" class="hash-link" aria-label="Direct link to Keystone components" title="Direct link to Keystone components">​</a></h2>
<p>A Keystone-capable system is made up of different modules operating in various privilege modes as shown in the figure below:</p>
<p><img decoding="async" loading="lazy" alt="keystoneComponents" src="/assets/images/keystone-components-40b1798d042edeb4821dbd8bc681d037.png" width="1599" height="746" class="img_ev3q"> <em>Keystone system with host processes, untrusted OS, security monitor, and multiple enclaves (each with runtime and eapp)</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="trusted-hardware">Trusted Hardware<a href="#trusted-hardware" class="hash-link" aria-label="Direct link to Trusted Hardware" title="Direct link to Trusted Hardware">​</a></h4>
<p>Trusted Hardware is a CPU package built by an honest manufacturer that must enclose standard RISC-V cores, which are Keystone compatible, and a root of trust. Optional features of the hardware could also include memory encryption, cache partitioning, a cryptographically safe source of randomness, etc. Platform-specific plug-ins are needed by the Security Monitor to support optional features.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="security-monitor">Security Monitor<a href="#security-monitor" class="hash-link" aria-label="Direct link to Security Monitor" title="Direct link to Security Monitor">​</a></h3>
<p><strong>Security Monitor (SM)</strong> is a trusted software that runs in M-mode and works as the small TCB in the Keystone system. Before the SM can be considered trusted, it must be verified by the hardware root of trust. Then, the root of trust <em>measures</em> the SM, generates a keypair for remote attestation, signs the public key, and eventually can continue booting. The measurement of the SM consists in computing the hash of the SM firmware image. The SM manages isolation boundaries between the enclaves and the untrusted OS, therefore it implements the majority of Keystone&#x27;s security guarantees.  It serves as an interface for managing the enclave&#x27;s lifecycle and utilising platform-specific features. The OS and enclaves may call SM functions using the Supervisor Binary Interface (SBI). Specifically, the SM provides the following functionality:</p>
<ul>
<li><em>memory isolation</em> using RISC-V PMP</li>
<li><em>remote attestation</em> (signatures and measurement): the goal is to demonstrate to a remote client that the enclave contains the expected application, and is running on trusted hardware</li>
<li>and other features, such as system PMP synchronization, enclave thread management and side-channel defences</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="runtime">Runtime<a href="#runtime" class="hash-link" aria-label="Direct link to Runtime" title="Direct link to Runtime">​</a></h3>
<p>Keystone developers implemented the <strong>Runtime (RT)</strong> with the goal of minimal and flexible TCB. It is an S-mode software. As a result, enclave applications can use modular system-level abstraction (e.g., virtual memory management). It provides kernel-like functionality, such as system calls, trap handling, virtual memory management and so on. Although the RT functions similarly to a kernel inside an enclave, most kernel functionalities are not necessary for the enclave application. To allow enclave developers to include only the necessary functionality and minimize the TCB, Keystone developers created an example of RT called Eyrie. It enables reusability since it is compatible with multiple-user programs. And by adding RT modules, they expand RT functionality without changing user applications or without complicating the SM.</p>
<p><img decoding="async" loading="lazy" alt="runtime-example" src="/assets/images/runtime-87a3226d8a9e902dc6ce2f2dd98efe62.svg" width="981" height="321" class="img_ev3q"> <em>Example of runtime reusability on the left and its functionalities on the right</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="enclave">Enclave<a href="#enclave" class="hash-link" aria-label="Direct link to Enclave" title="Direct link to Enclave">​</a></h3>
<p>An <strong>Enclave</strong> is an environment isolated from the untrusted OS and other enclaves. Each enclave is provided with a private physical memory region which is accessible by only the enclave and SM. Each enclave consists of a user-level enclave application called <em>eapp</em> and a supervisor-level runtime. An eapp is a user-level application that executes in the enclave. A developer can create a custom eapp from scratch, or just execute an existing RISC-V binary in Keystone. The enclave lifecycle is shown below.</p>
<p><img decoding="async" loading="lazy" alt="enclave-lifecycle" src="/assets/images/Enclave lifecycle-4bcbdb8b30aba6302e4adb8c2901b8b3.png" width="960" height="720" class="img_ev3q"> <em>Enclave Lifecycle from Keystone docs</em></p>
<p>The main phases are:</p>
<ul>
<li><em>creation</em>: when an enclave is started it has a contiguous range of physical memory that is called Enclave Private Memory (EPM). In the beginning, the EPM is allocated by the untrusted host, which initialises it with the enclave&#x27;s page table, the runtime and the enclave application. When the untrusted host calls the SM to create an enclave, the SM isolates and secures the EPM using a PMP entry, and then the PMP status is propagated throughout all of the system&#x27;s cores. Subsequently, before the enclave execution, the enclave&#x27;s initial state is measured and verified by the SM.</li>
<li><em>execution</em>: the SM enters the enclave on one of the cores as soon as the untrusted asks for it. The PMP permission is enabled to the core by the SM, and the core starts running the eapp. The RT can exit or re-enter the enclave at any time depending on the execution flow of the eapp. The PMP permissions are switched to keep the isolation each time a core exits or enters the enclave.</li>
<li><em>destruction</em>: the untrusted host may want to destroy the enclave at any moment, when it happens, the EPM is cleared by the SM and the PMP entry is freed. The untrusted host then definitely reclaims the released memory.</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="edge-calls">Edge Calls<a href="#edge-calls" class="hash-link" aria-label="Direct link to Edge Calls" title="Direct link to Edge Calls">​</a></h3>
<p>Function calls that enter or exit the enclave are known as <em>edge calls</em> in Keystone, as in other enclave systems. For instance, if an enclave wants to send a network packet, it must use an edge call to deliver the data to an untrusted host process. The current version of Keystone allows <em>enclave</em> <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>→</mo></mrow><annotation encoding="application/x-tex">\rightarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.3669em"></span><span class="mrel">→</span></span></span></span> <em>untrusted host</em> calls, also known internally as <em>ocalls</em> (outbound calls, names under discussion). In the current version of Keystone, all ocall wrapping code uses shared memory regions to transfer data. When referencing data in these regions virtual address pointers are never used, instead, only offsets into the region are used.</p>
<p><img decoding="async" loading="lazy" alt="ocall-lifecycle" src="/assets/images/ocall-5ad7272051de9839839fc58626f9fb6f.svg" width="1069" height="573" class="img_ev3q"> <em>Simplified example of an ocall lifecycle</em></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="edge-calls-lifecycle">Edge Calls Lifecycle<a href="#edge-calls-lifecycle" class="hash-link" aria-label="Direct link to Edge Calls Lifecycle" title="Direct link to Edge Calls Lifecycle">​</a></h4>
<p>Consider for example a generic <code>ocall_do_something</code>, as represented in Fig. [ocall-lifecycle]. This call transfers some values passed as arguments from the enclave to be processed by the host process (it could be a value to be printed, a file to be stored and so on). The enclave application calls <code>ocall_do_something(...)</code>, which is an edge wrapper function.<br>
<code>ocall_do_something(...)</code> uses the system-call-like interface to the runtime to execute an <em>ocalls</em> similar to <code>ocall(OCALL_DO_SOMETHING, &amp;input, sizeof(input), &amp;ouput,  sizeof(output))</code>. The enclave passes a pointer to the value, the size of the argument and any necessary return buffer information.
After allocating an <code>edge_call</code> structure in the shared memory region, the runtime fills out the call type, copies the value into another part of the shared memory, and sets up the offset to the argument value. Note that, in Keystone, edge calls employ offset values in the shared memory area, rather than pointers.
The runtime subsequently exits the enclave with an <code>SBI_CALL</code>, i.e. <code>sbi_stop_enclave()</code>, passing a value indicating that the enclave is executing an <em>ocalls</em> rather than shutting down.</p>
<p>After resuming execution of the Keystone kernel driver, it checks the enclave&#x27;s exit status, notes a pending <em>ocalls</em> and handles control to the userspace host process.
The registered <em>ocalls</em> handler wrapper for <code>OCALL_DO_SOMETHING</code> is dispatched by the userspace host process, which also consumes the edge call. The wrapper generates a pointer to the argument value from the offset in the shared memory region and then calls <code>do_something</code> with the value as an argument. The host wrapper determines whether any return values must be copied into the shared memory region upon return and returns the control to the driver after setting the edge call return status to <code>SUCCESS</code>.</p>
<p>Through an <code>SBI_CALL</code>, the driver rejoins the enclave runtime. The enclave <em>ocalls</em> wrapper code is resumed once the runtime determines whether any return information has to be copied from the shared region into return buffers. Finally, the enclave function that has called at the beginning <code>ocall_do_something</code> receives any return values from the <em>ocalls</em> wrapper code.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="memory-isolation-using-risc-v-pmp">Memory isolation using RISC-V PMP<a href="#memory-isolation-using-risc-v-pmp" class="hash-link" aria-label="Direct link to Memory isolation using RISC-V PMP" title="Direct link to Memory isolation using RISC-V PMP">​</a></h2>
<p>In Keystone, developers refer to the memory section that an enclave uses as a <em>region</em> and each region is defined by a PMP entry. The SM employs two PMP registers for internal purposes (i.e. security monitor memory and untrusted memory). One active enclave may use one of the remaining PMP entries each. RISC-V PMP has several properties, the most relevant are:</p>
<ul>
<li>prioritization by index: the index of PMP entries statically determines the priority. Indices go from <code>0</code> to <code>N</code>, where <code>N</code> depends upon the platform. <code>0</code> is the highest priority, whereas <code>N</code> is the lowest</li>
<li>default denies: if no PMP entry matches with an address, the memory access will be rejected by default.</li>
</ul>
<p>For simplicity, in the following explanation PMP entries are denoted as <code>pmp[i]</code> where <code>i</code> is an index. Below is a representation of the memory in its initial state. At the start of the boot process, physical memory is not accessible by U- or S-modes.</p>
<div class="language-title=&quot; codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot; codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-: inaccessible (NO_PERM), =: accessible (ALL_PERM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[1:N]    |                                       | : undefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net result  |---------------------------------------|   </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The SM sets the highest priority PMP entry to cover the address range containing itself and sets all permission bits to 0. Suddenly, the SM sets the lowest priority PMP entry to cover the full memory and sets all permission bits to 1, this will allow the OS to access the remaining memory and start booting. The result can be seen below.</p>
<div class="language-title=&quot;Memory language-title=&quot;memory codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot;memory codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-: inaccessible (NO_PERM), =: accessible (ALL_PERM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[0]       |-------|                              | : SM memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[others]  |                                      | : undefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[N]       |======================================| : OS memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net result   |-------|==============================|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>As shown below, every time the SM creates an enclave, it will select a PMP entry for the enclave to defend its memory from other U-/S-mode software.</p>
<div class="language-title=&quot;Memory language-title=&quot;memory codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot;memory codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-: inaccessible (NO_PERM), =: accessible (ALL_PERM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[0]       |-------|                              | : SM memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[1]       |              |---------|             | : enclave </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[others]  |                                      | : undefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[N]       |======================================| : OS memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net result   |-------|======|---------|=============|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When the SM enters the enclave and executes the eapp, it flips the permission bits of the enclave&#x27;s PMP entry and the last PMP entry. Untrusted shared buffer is the term for the contiguous memory region that Keystone enables the OS to allocate in the OS memory space in order to use it as an enclave&#x27;s communication buffer. This is shown below.<br>
<!-- -->The SM just flips the permission bits back when it leaves the enclave. When an enclave is destroyed by the SM, the PMP entry is made available for usage by other enclaves.</p>
<div class="language-title=&quot;Memory language-title=&quot;memory codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-title=&quot;memory codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-: inaccessible (NO_PERM), =: accessible (ALL_PERM)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[0]       |-------|                              | : SM memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[1]       |              |=========|             | : enclave </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        memory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[others]  |                                      | : undefined</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pmp[N]       |                                |==|  | : untrusted </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        shared </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                                        buffer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">net result   |-------|------|=========|-------|==|--|</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="keystone-key-hierarchy">Keystone key-hierarchy<a href="#keystone-key-hierarchy" class="hash-link" aria-label="Direct link to Keystone key-hierarchy" title="Direct link to Keystone key-hierarchy">​</a></h2>
<p>Below is shown the key hierarchy of Keystone. The root of the key hierarchy is the asymmetric processor key pair (<code>SK_D</code> and  <code>PK_D</code>). The asymmetric security monitor key pair (<code>SK_SK</code> and <code>PK_SM</code>) is derived from the measurement of the security monitor (<code>H_SM</code>) and the private processor key (<code>SK_D</code>).
As a result, the computed security monitor key pair is bound to the processor and to the identity of the security monitor itself.</p>
<p><img decoding="async" loading="lazy" alt="keystone-key-hierarchy" src="/assets/images/Keystone key hierarchy-117a0881f26bf87a76b8de575feb9075.svg" width="963" height="264" class="img_ev3q"> <em>The key hierarchy of Keystone</em></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="sealing-key-derivation">Sealing-Key Derivation<a href="#sealing-key-derivation" class="hash-link" aria-label="Direct link to Sealing-Key Derivation" title="Direct link to Sealing-Key Derivation">​</a></h3>
<p>The image above also illustrates how <em>sealing-keys</em> are derived. An enclave can generate a key for data encryption using the data-sealing capability, enabling it to store data in untrusted non-volatile memory outside the enclave. This key is tied to the identity of the processor, the security monitor, and the enclave. As a result, only the same enclave using the same processor and security monitor can generate the same key. Data can be encrypted using this key and stored in unsecured, non-volatile memory. After an enclave restart, it can generate the same key once more, retrieve the encrypted data from the untrusted storage, and then use the derived key to decrypt it. A sealing key is computed starting from three inputs:</p>
<ul>
<li>the private security monitor key (<code>SK_SM</code>)</li>
<li>the hash of the enclave (<code>H_SM</code>)</li>
<li>a key identifier
The key identifier is an extra input for the key derivation function selectable by the enclave. A single enclave can generate several keys by giving the key identifier various values.</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a href="#resources" class="hash-link" aria-label="Direct link to Resources" title="Direct link to Resources">​</a></h2>
<ul>
<li><a href="https://doi.org/10.1109/Trustcom.2015.357" target="_blank" rel="noopener noreferrer">Trusted Execution Environment: What It is, and What It is Not</a>, Sabt, Mohamed and Achemlal, Mohammed and Bouabdallah, Abdelmadjid</li>
<li><a href="https://blog.quarkslab.com/introduction-to-trusted-execution-environment-arms-trustzone.html" target="_blank" rel="noopener noreferrer">Introduction to Trusted Execution Environment: ARM&#x27;s TrustZone</a></li>
<li><a href="https://apps.dtic.mil/sti/pdfs/ADA108831.pdf" target="_blank" rel="noopener noreferrer">Specification of a trusted computing base (TCB)</a></li>
<li><a href="https://keystone-enclave.org/blog/" target="_blank" rel="noopener noreferrer">Keystone blog</a></li>
<li><a href="https://docs.keystone-enclave.org/en/latest/index.html" target="_blank" rel="noopener noreferrer">Keystone Enclave&#x27;s documentation</a></li>
<li><a href="https://doi.org/10.1145/3342195.3387532" target="_blank" rel="noopener noreferrer">Keystone: An open framework for architecting trusted execution environments</a>, Lee, Dayeol and Kohlbrenner, David and Shinde, Shweta and Asanovi&#x27;c, Krste and Song, Dawn</li>
<li><a href="https://sifive.github.io/freedom-metal-docs/devguide/pmps.html" target="_blank" rel="noopener noreferrer">Physical Memory Protection</a></li>
<li><a href="https://riscv.org/technical/specifications/" target="_blank" rel="noopener noreferrer">RISC-V Specification Documentations</a></li>
</ul></div><footer class="docusaurus-mt-lg"><div class="row margin-top--sm theme-blog-footer-edit-meta-row"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/trusted-computing">trusted-computing</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/what-i-learnt-using-actix-web"><div class="pagination-nav__sublabel">Older post</div><div class="pagination-nav__label">What I learnt using Actix-web</div></a></nav></main><div class="col col--2"><div class="tableOfContents_bqdL thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#trusted-execution-environment" class="table-of-contents__link toc-highlight">Trusted Execution Environment</a><ul><li><a href="#customizable-trusted-execution-environment" class="table-of-contents__link toc-highlight">Customizable Trusted Execution Environment</a></li></ul></li><li><a href="#risc-v-background" class="table-of-contents__link toc-highlight">RISC-V Background</a><ul><li><a href="#risc-v-privilieged-isa" class="table-of-contents__link toc-highlight">RISC-V Privilieged ISA</a></li><li><a href="#physical-memory-protection" class="table-of-contents__link toc-highlight">Physical Memory Protection</a></li></ul></li><li><a href="#keystone-components" class="table-of-contents__link toc-highlight">Keystone components</a><ul><li><a href="#security-monitor" class="table-of-contents__link toc-highlight">Security Monitor</a></li><li><a href="#runtime" class="table-of-contents__link toc-highlight">Runtime</a></li><li><a href="#enclave" class="table-of-contents__link toc-highlight">Enclave</a></li><li><a href="#edge-calls" class="table-of-contents__link toc-highlight">Edge Calls</a></li></ul></li><li><a href="#memory-isolation-using-risc-v-pmp" class="table-of-contents__link toc-highlight">Memory isolation using RISC-V PMP</a></li><li><a href="#keystone-key-hierarchy" class="table-of-contents__link toc-highlight">Keystone key-hierarchy</a><ul><li><a href="#sealing-key-derivation" class="table-of-contents__link toc-highlight">Sealing-Key Derivation</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Luca Giorgino. Built with Docusaurus. Image by storyset on <a href="https://www.freepik.com">Freepik</a></div></div></div></footer></div>
</body>
</html>